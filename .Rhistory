head(events_data)
head(insurance_data)
head(prop_insurance)
prop_insurance <- prop_insurance[-c(1:3)]
#plot(prop_insurance$Property_Insurance_Index ~ insurance_data$All_Insurance_Index)
load("12_cleanedData.RData")
head(events_data)
head(insurance_data)
head(prop_insurance)
prop_insurance <- prop_insurance[-c(1:3),]
#plot(prop_insurance$Property_Insurance_Index ~ insurance_data$All_Insurance_Index)
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
#events in US from 1980 - 2024
events_data <- read.csv("data/events-US-1980-2024-Q4.csv")
events_data <- na.omit(events_data)
events_data <- events_data[-c(1, 2), ]
#insurance data
insurance_data <- read.csv("data/all_insurance_costs.csv")
insurance_data <- na.omit(insurance_data)
#property insurance cost data
prop_insurance <- read.csv("data/property_insurance_costs.csv")
prop_insurance <- na.omit(prop_insurance)
colnames(events_data) <- c("Name_Date", #chr
"Disaster_Type", #chr
"Begin_Date", #num -> chr (date format)
"End_Date", #num -> chr (date format)
"CPI_Adjusted_Cost_Millions", #num
"Unadjusted_Cost_Millions", #num
"Deaths") #int
events_data$CPI_Adjusted_Cost_Millions <- as.numeric(events_data$CPI_Adjusted_Cost_Millions)
events_data$Unadjusted_Cost_Millions <- as.numeric(events_data$Unadjusted_Cost_Millions)
events_data$Deaths <- as.integer(events_data$Deaths)
events_data$Begin_Date <- as.Date(as.character(events_data$Begin_Date),
format = "%Y%m%d")
events_data$End_Date <- as.Date(as.character(events_data$End_Date),
format = "%Y%m%d")
events_data$CPI_Adjusted_Cost_Millions <- as.numeric(events_data$CPI_Adjusted_Cost_Millions)
events_data$Unadjusted_Cost_Millions <- as.numeric(events_data$Unadjusted_Cost_Millions)
events_data$Deaths <- as.numeric(events_data$Deaths)
head(events_data)
dim(events_data)
colnames(insurance_data) <- c("PPI_Series_ID",
"Year",
"Month_Code",
"Time_Period",
"All_Insurance_Index")
head(insurance_data)
colnames(prop_insurance) <- c("Series_ID",
"Year",
"Month_Code",
"Time_Period",
"Property_Insurance_Index")
head(prop_insurance)
#our property insurance contains data that the overall insurance does not have (2009 march-2009 may), so we will remove it to have thedata match 1-1
prop_insurance <- prop_insurance[-c(1:3),]
save.image("12_cleanedData.RData")
knitr::opts_chunk$set(echo = TRUE)
load("12_cleanedData.RData")
head(events_data)
head(insurance_data)
head(prop_insurance)
plot(prop_insurance$Property_Insurance_Index ~ insurance_data$All_Insurance_Index)
plot(prop_insurance$Property_Insurance_Index ~ insurance_data$All_Insurance_Index, xlab = "Relative price for all insurance", ylab = "Relative price of property insurance")
plot(prop_insurance$Property_Insurance_Index ~ insurance_data$All_Insurance_Index, xlab = "Relative price for all insurance", ylab = "Relative price of property insurance")
cor(prop_insurance$Property_Insurance_Index, insurance_data$All_Insurance_Index)
cor(prop_insurance$Property_Insurance_Index, insurance_data$All_Insurance_Index)
summary(lm(prop_insurance$Property_Insurance_Index ~ insurance_data$All_Insurance_Index))
?lm
View(events_data)
knitr::opts_chunk$set(echo = TRUE)
load("12_cleanedData.RData")
head(events_data)
head(insurance_data)
head(prop_insurance)
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
#events in US from 1980 - 2024
events_data <- read.csv("data/events-US-1980-2024-Q4.csv")
events_data <- na.omit(events_data)
events_data <- events_data[-c(1, 2), ]
#insurance data
insurance_data <- read.csv("data/all_insurance_costs.csv")
insurance_data <- na.omit(insurance_data)
#property insurance cost data
prop_insurance <- read.csv("data/property_insurance_costs.csv")
prop_insurance <- na.omit(prop_insurance)
colnames(events_data) <- c("Name_Date", #chr
"Disaster_Type", #chr
"Begin_Date", #num -> chr (date format)
"End_Date", #num -> chr (date format)
"CPI_Adjusted_Cost_Millions", #num
"Unadjusted_Cost_Millions", #num
"Deaths") #int
events_data$CPI_Adjusted_Cost_Millions <- as.numeric(events_data$CPI_Adjusted_Cost_Millions)
events_data$Unadjusted_Cost_Millions <- as.numeric(events_data$Unadjusted_Cost_Millions)
events_data$Deaths <- as.integer(events_data$Deaths)
events_data$Begin_Date <- as.Date(as.character(events_data$Begin_Date),
format = "%Y%m%d")
events_data$End_Date <- as.Date(as.character(events_data$End_Date),
format = "%Y%m%d")
events_data$CPI_Adjusted_Cost_Millions <- as.numeric(events_data$CPI_Adjusted_Cost_Millions)
events_data$Unadjusted_Cost_Millions <- as.numeric(events_data$Unadjusted_Cost_Millions)
events_data$Deaths <- as.numeric(events_data$Deaths)
head(events_data)
dim(events_data)
colnames(insurance_data) <- c("PPI_Series_ID",
"Year",
"Month_Code",
"Time_Period",
"All_Insurance_Index")
head(insurance_data)
colnames(prop_insurance) <- c("Series_ID",
"Year",
"Month_Code",
"Time_Period",
"Property_Insurance_Index")
head(prop_insurance)
save.image("12_cleanedData.RData")
knitr::opts_chunk$set(echo = TRUE)
load("12_cleanedData.RData")
head(events_data)
head(insurance_data)
head(prop_insurance)
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
#events in US from 1980 - 2024
events_data <- read.csv("data/events-US-1980-2024-Q4.csv")
events_data <- na.omit(events_data)
events_data <- events_data[-c(1, 2), ]
#insurance data
overall_insurance <- read.csv("data/all_insurance_costs.csv")
overall_insurance <- na.omit(overall_insurance)
#property insurance cost data
prop_insurance <- read.csv("data/property_insurance_costs.csv")
prop_insurance <- na.omit(prop_insurance)
colnames(events_data) <- c("Name_Date", #chr
"Disaster_Type", #chr
"Begin_Date", #num -> chr (date format)
"End_Date", #num -> chr (date format)
"CPI_Adjusted_Cost_Millions", #num
"Unadjusted_Cost_Millions", #num
"Deaths") #int
events_data$CPI_Adjusted_Cost_Millions <- as.numeric(events_data$CPI_Adjusted_Cost_Millions)
events_data$Unadjusted_Cost_Millions <- as.numeric(events_data$Unadjusted_Cost_Millions)
events_data$Deaths <- as.integer(events_data$Deaths)
events_data$Begin_Date <- as.Date(as.character(events_data$Begin_Date),
format = "%Y%m%d")
events_data$End_Date <- as.Date(as.character(events_data$End_Date),
format = "%Y%m%d")
events_data$CPI_Adjusted_Cost_Millions <- as.numeric(events_data$CPI_Adjusted_Cost_Millions)
events_data$Unadjusted_Cost_Millions <- as.numeric(events_data$Unadjusted_Cost_Millions)
events_data$Deaths <- as.numeric(events_data$Deaths)
head(events_data)
dim(events_data)
colnames(overall_insurance) <- c("PPI_Series_ID",
"Year",
"Month_Code",
"Time_Period",
"All_Insurance_Index")
head(overall_insurance)
colnames(prop_insurance) <- c("Series_ID",
"Year",
"Month_Code",
"Time_Period",
"Property_Insurance_Index")
head(prop_insurance)
save.image("12_cleanedData.RData")
knitr::opts_chunk$set(echo = TRUE)
load("12_cleanedData.RData")
head(events_data)
head(overall_insurance)
head(prop_insurance)
prop_insurance <- prop_insurance[-c(1:3),]
all_insurance <- merge(prop_insurance, overall_insurance)
View(all_insurance)
all_insurance <- merge(prop_insurance, overall_insurance)
head(all_insurance)
all_insurance <- all_insurance[ -c(3,4,6)]
head(all_insurance)
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
source("00_requirements.R")
#events in US from 1980 - 2024
events_data <- read.csv("data/events-US-1980-2024-Q4.csv")
events_data <- na.omit(events_data)
events_data <- events_data[-c(1, 2), ]
#insurance data
overall_insurance <- read.csv("data/all_insurance_costs.csv")
overall_insurance <- na.omit(overall_insurance)
#property insurance cost data
prop_insurance <- read.csv("data/property_insurance_costs.csv")
prop_insurance <- na.omit(prop_insurance)
colnames(events_data) <- c("Name_Date", #chr
"Disaster_Type", #chr
"Begin_Date", #num -> chr (date format)
"End_Date", #num -> chr (date format)
"CPI_Adjusted_Cost_Millions", #num
"Unadjusted_Cost_Millions", #num
"Deaths") #int
events_data$CPI_Adjusted_Cost_Millions <- as.numeric(events_data$CPI_Adjusted_Cost_Millions)
events_data$Unadjusted_Cost_Millions <- as.numeric(events_data$Unadjusted_Cost_Millions)
events_data$Deaths <- as.integer(events_data$Deaths)
events_data$Begin_Date <- as.Date(as.character(events_data$Begin_Date),
format = "%Y%m%d")
events_data$End_Date <- as.Date(as.character(events_data$End_Date),
format = "%Y%m%d")
events_data$CPI_Adjusted_Cost_Millions <- as.numeric(events_data$CPI_Adjusted_Cost_Millions)
events_data$Unadjusted_Cost_Millions <- as.numeric(events_data$Unadjusted_Cost_Millions)
events_data$Deaths <- as.numeric(events_data$Deaths)
head(events_data)
dim(events_data)
colnames(overall_insurance) <- c("PPI_Series_ID",
"Year",
"Month_Code",
"Time_Period",
"All_Insurance_Index")
head(overall_insurance)
colnames(prop_insurance) <- c("Series_ID",
"Year",
"Month_Code",
"Time_Period",
"Property_Insurance_Index")
head(prop_insurance)
save.image("12_cleanedData.RData")
install.packages("data.table")
install.packages("tidyverse")
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# Load your data files (you can comment out one if not needed)
load("22_processedData.RData")
# Convert key columns to correct types
events_data$CPI_Adjusted_Cost_Millions <- as.numeric(events_data$CPI_Adjusted_Cost_Millions)
all_insurance$All_Insurance_Index       <- as.numeric(all_insurance$All_Insurance_Index)
all_insurance$Property_Insurance_Index  <- as.numeric(all_insurance$Property_Insurance_Index)
plot(
all_insurance$All_Insurance_Index,
all_insurance$Property_Insurance_Index,
xlab = "Relative price for all insurance",
ylab = "Relative price for property insurance",
main = "Property vs All Insurance Indices",
pch = 16, col = rgb(0,0,0,0.5)
)
abline(lm(Property_Insurance_Index ~ All_Insurance_Index, data = all_insurance),
col = "red", lwd = 2)
tbl <- sort(table(events_data$Disaster_Type), decreasing = TRUE)
par(mar = c(5,10,4,2) + 0.1)
barplot(tbl, horiz = TRUE, las = 1,
main = "Frequency of Major Disasters by Type",
xlab = "Count")
## Time Series Analysis
# 1. Extract the year from the 'Insurance_Month' Date column
# We create a new column 'Calc_Year' to aggregate by.
all_insurance$Calc_Year <- format(all_insurance$Insurance_Month, "%Y")
# 2. Annual mean indices from monthly insurance table
# We now aggregate using the newly created 'Calc_Year'
annual_all  <- aggregate(all_insurance$All_Insurance_Index ~ all_insurance$Calc_Year,
FUN = mean, na.rm = TRUE)
annual_prop <- aggregate(all_insurance$Property_Insurance_Index ~ all_insurance$Calc_Year,
FUN = mean, na.rm = TRUE)
# 3. Rename the columns (The grouping column is now the 'Year')
names(annual_all)  <- c("Year","AllIdx")
names(annual_prop) <- c("Year","PropIdx")
# 4. Align on common years
ii <- merge(annual_all, annual_prop, by="Year")
ii$Year <- as.integer(as.character(ii$Year))
# convert to numeric years
# 5. Plot the time series
rng <- range(c(ii$AllIdx, ii$PropIdx), na.rm = TRUE)
plot(ii$Year, ii$AllIdx,
type = "l",
col = "blue",
lwd = 2,
xlab = "Year",
ylab = "Insurance Index",
main = "Insurance Price Trends Over Time",
ylim = rng)
lines(ii$Year, ii$PropIdx,
col = "red",
lwd = 2)
legend("topleft",
legend = c("All Insurance","Property Insurance"),
col = c("blue","red"),
lwd = 2,
bty = "n")
# 1) Histogram of monthly disaster costs
# 2) Boxplot of event cost by type (log-scale)
# 3) Top 6 disaster types by total CPI-adjusted cost
# 4. Align on common years
op <- par(no.readonly = TRUE); on.exit(par(op))
par(mfrow = c(1, 3), mar = c(8, 4, 3, 1))  # set layout BEFORE plotting
## (1) Histogram (monthly disaster costs)
hist(all_insurance$Disaster_Cost, breaks = "FD",
main = "Monthly Disaster Costs",
xlab = "Cost (Millions)")
## (2) Boxplot by disaster type (horizontal, log-scale)
par(mar = c(5, 7, 3, 1), cex.axis = 0.9)  # extra left room for labels
boxplot(CPI_Adjusted_Cost_Millions ~ Disaster_Type, data = events_data,
horizontal = TRUE, log = "x", las = 1,
xlab = "Cost (Millions, log scale)",
ylab =  "",
main = "Event Cost by Type (Log)")
## (3) Top 6 types by total CPI-adjusted cost  (rotation fix: horizontal bars)
tot_by_type <- tapply(events_data$CPI_Adjusted_Cost_Millions,
events_data$Disaster_Type, sum, na.rm = TRUE)
tot_by_type <- sort(tot_by_type, decreasing = TRUE)
top6 <- head(tot_by_type, 6)
barplot(top6,
horiz = TRUE, las = 1, xlab = "Total Cost (Millions)",
main = "Top 6 Types by Total Cost", col = "gray70")
# Check whether prior disaster costs relate to current insurance index
# Uses 0, 6, and 12 month lags
op <- par(no.readonly = TRUE); on.exit(par(op))
par(mfrow = c(1, 3), mar = c(4,4,3,1))
ord <- seq_len(nrow(all_insurance))
dc  <- all_insurance$Disaster_Cost[ord]
idx <- all_insurance$All_Insurance_Index[ord]
lagK <- function(x, k) c(rep(NA, k), head(x, -k))
lags <- list(
"Same Month" = 0L,
"Lag 6"      = 6L,
"Lag 12"     = 12L
)
i <- 1
for (nm in names(lags)) {
k  <- lags[[nm]]
lx <- if (k == 0L) dc else lagK(dc, k)
plot(lx, idx,
xlab = paste0("Disaster Cost (lag ", k, " mo)"),
ylab = "All Insurance Index",
main = nm,
pch = 16, col = rgb(0,0,0,0.4))
ok <- is.finite(lx) & is.finite(idx)
if (sum(ok) > 2) abline(lm(idx[ok] ~ lx[ok]), col = "red", lwd = 2)
i <- i + 1
}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
source("00_requirements.R")
load("12_cleanedData.RData")
head(events_data)
head(overall_insurance)
head(prop_insurance)
prop_insurance <- prop_insurance[-c(1:3),]
all_insurance <- merge(prop_insurance, overall_insurance)
head(all_insurance)
#we can now get rid of all and prop insurance
rm(overall_insurance)
rm(prop_insurance)
all_insurance <- all_insurance[ -c(3,4,6)]
head(all_insurance)
head(events_data)
events_data$Begin_Date <- floor_date(events_data$Begin_Date, "month")
events_data$End_Date <- floor_date(events_data$End_Date, "month")
head(events_data)
events_data$Duration_Interval <- interval(events_data$Begin_Date, events_data$End_Date)
events_data$Duration_Months <- as.period(events_data$Duration_Interval
) %/% months(1) + 1
#events_data$Duration_Months
events_data$Adjusted_CPM_Millions <- events_data$CPI_Adjusted_Cost_Millions / events_data$Duration_Months
events_data$Unadjusted_CPM_Millions <- events_data$Unadjusted_Cost_Millions / events_data$Duration_Months
head(events_data)
all_insurance$Month <- substr(all_insurance$Month_Code, 2, 3)
all_insurance$Calc_Date <- as.Date(
paste(all_insurance$Year, all_insurance$Month, "1", sep = "-")
)
head(all_insurance)
all_insurance$Disaster_Cost <- 0
A <- all_insurance[,c(6:7)] #get date
B <- events_data[,c(3,4,10)] #get date interval and disaster cost
#idk if this is neccessary but its the example on the rdocumentation website so ill go with what i know works https://www.rdocumentation.org/packages/data.table/versions/1.17.8/topics/foverlaps
A$start <- A$Calc_Date
A$end <- A$Calc_Date
B$start <- B$Begin_Date
B$end <- B$End_Date
B <- data.table(B)
A <- data.table(A)
setkey(B, start, end)
overlaps <- foverlaps(A, B, type = "any", which = TRUE)
overlaps <- data.frame(overlaps)
for (i in 1:nrow(overlaps)) {
monthindex <- overlaps[i,1]
costindex <- overlaps[i,2]
all_insurance[monthindex,]$Disaster_Cost <- all_insurance[monthindex,]$Disaster_Cost + B[costindex,]$Adjusted_CPM_Millions
}
rm(A, B, i, costindex, monthindex)
head(all_insurance)
#i testesd this with an inefficeint brute force alg and it matches up, although leaves N/A where the cost is 0, thats fine
#we can use the month date instead with month(date) and year(date)
all_insurance$Year <- NULL
all_insurance$Month <- NULL
all_insurance$Month_Code <- NULL
all_insurance <- all_insurance[, c("Calc_Date", "Disaster_Cost", "Property_Insurance_Index", "All_Insurance_Index")]
colnames(all_insurance)[1] <- "Insurance_Month"
#if the sum was 0 the cost is n/a, turn that back into 0
#taken from tidyverse replace na reference
all_insurance$Disaster_Cost <- replace_na(all_insurance$Disaster_Cost, 0)
head(all_insurance)
events_data$Duration_Interval <- NULL
colnames(events_data)[3] <- "Begin_Month"
colnames(events_data)[4] <- "End_Month"
head(events_data)
save.image("22_processedData.RData")
install.packages("data.table")
install.packages("tidyverse")
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# Load your data files (you can comment out one if not needed)
load("22_processedData.RData")
# Convert key columns to correct types
events_data$CPI_Adjusted_Cost_Millions <- as.numeric(events_data$CPI_Adjusted_Cost_Millions)
all_insurance$All_Insurance_Index       <- as.numeric(all_insurance$All_Insurance_Index)
all_insurance$Property_Insurance_Index  <- as.numeric(all_insurance$Property_Insurance_Index)
plot(
all_insurance$All_Insurance_Index,
all_insurance$Property_Insurance_Index,
xlab = "Relative price for all insurance",
ylab = "Relative price for property insurance",
main = "Property vs All Insurance Indices",
pch = 16, col = rgb(0,0,0,0.5)
)
abline(lm(Property_Insurance_Index ~ All_Insurance_Index, data = all_insurance),
col = "red", lwd = 2)
tbl <- sort(table(events_data$Disaster_Type), decreasing = TRUE)
par(mar = c(5,10,4,2) + 0.1)
barplot(tbl, horiz = TRUE, las = 1,
main = "Frequency of Major Disasters by Type",
xlab = "Count")
## Time Series Analysis
# 1. Extract the year from the 'Insurance_Month' Date column
# We create a new column 'Calc_Year' to aggregate by.
all_insurance$Calc_Year <- format(all_insurance$Insurance_Month, "%Y")
# 2. Annual mean indices from monthly insurance table
# We now aggregate using the newly created 'Calc_Year'
annual_all  <- aggregate(all_insurance$All_Insurance_Index ~ all_insurance$Calc_Year,
FUN = mean, na.rm = TRUE)
annual_prop <- aggregate(all_insurance$Property_Insurance_Index ~ all_insurance$Calc_Year,
FUN = mean, na.rm = TRUE)
# 3. Rename the columns (The grouping column is now the 'Year')
names(annual_all)  <- c("Year","AllIdx")
names(annual_prop) <- c("Year","PropIdx")
# 4. Align on common years
ii <- merge(annual_all, annual_prop, by="Year")
ii$Year <- as.integer(as.character(ii$Year))
# convert to numeric years
# 5. Plot the time series
rng <- range(c(ii$AllIdx, ii$PropIdx), na.rm = TRUE)
plot(ii$Year, ii$AllIdx,
type = "l",
col = "blue",
lwd = 2,
xlab = "Year",
ylab = "Insurance Index",
main = "Insurance Price Trends Over Time",
ylim = rng)
lines(ii$Year, ii$PropIdx,
col = "red",
lwd = 2)
legend("topleft",
legend = c("All Insurance","Property Insurance"),
col = c("blue","red"),
lwd = 2,
bty = "n")
# 1) Histogram of monthly disaster costs
# 2) Boxplot of event cost by type (log-scale)
# 3) Top 6 disaster types by total CPI-adjusted cost
# 4. Align on common years
op <- par(no.readonly = TRUE); on.exit(par(op))
par(mfrow = c(1, 3), mar = c(8, 4, 3, 1))  # set layout BEFORE plotting
## (1) Histogram (monthly disaster costs)
hist(all_insurance$Disaster_Cost, breaks = "FD",
main = "Monthly Disaster Costs",
xlab = "Cost (Millions)")
## (2) Boxplot by disaster type (horizontal, log-scale)
par(mar = c(5, 7, 3, 1), cex.axis = 0.9)  # extra left room for labels
boxplot(CPI_Adjusted_Cost_Millions ~ Disaster_Type, data = events_data,
horizontal = TRUE, log = "x", las = 1,
xlab = "Cost (Millions, log scale)",
ylab =  "",
main = "Event Cost by Type (Log)")
## (3) Top 6 types by total CPI-adjusted cost  (rotation fix: horizontal bars)
tot_by_type <- tapply(events_data$CPI_Adjusted_Cost_Millions,
events_data$Disaster_Type, sum, na.rm = TRUE)
tot_by_type <- sort(tot_by_type, decreasing = TRUE)
top6 <- head(tot_by_type, 6)
barplot(top6,
horiz = TRUE, las = 1, xlab = "Total Cost (Millions)",
main = "Top 6 Types by Total Cost", col = "gray70")
# Check whether prior disaster costs relate to current insurance index
# Uses 0, 6, and 12 month lags
op <- par(no.readonly = TRUE); on.exit(par(op))
par(mfrow = c(1, 3), mar = c(4,4,3,1))
ord <- seq_len(nrow(all_insurance))
dc  <- all_insurance$Disaster_Cost[ord]
idx <- all_insurance$All_Insurance_Index[ord]
lagK <- function(x, k) c(rep(NA, k), head(x, -k))
lags <- list(
"Same Month" = 0L,
"Lag 6"      = 6L,
"Lag 12"     = 12L
)
i <- 1
for (nm in names(lags)) {
k  <- lags[[nm]]
lx <- if (k == 0L) dc else lagK(dc, k)
plot(lx, idx,
xlab = paste0("Disaster Cost (lag ", k, " mo)"),
ylab = "All Insurance Index",
main = nm,
pch = 16, col = rgb(0,0,0,0.4))
ok <- is.finite(lx) & is.finite(idx)
if (sum(ok) > 2) abline(lm(idx[ok] ~ lx[ok]), col = "red", lwd = 2)
i <- i + 1
}
