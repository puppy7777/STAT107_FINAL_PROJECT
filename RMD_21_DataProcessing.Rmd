---
title: "RMD_21_DataProcessing"
output: html_document
date: "2025-11-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Processing

```{r reset env}
rm(list = ls())
source("00_requirements.R")
```

```{r}
load("12_cleanedData.RData")
head(events_data)
head(overall_insurance)
head(prop_insurance)
```

Our overall insurance data does not contain the months of March 2009 to May 2009, so we will remove them from the property insurance data so they can match 1 to 1

```{r matchprop}
prop_insurance <- prop_insurance[-c(1:3),]
```

We can now merge the 2 datasets, since they match 1 to 1 in terms of date. We can also get rid of useless columns

```{r datamerge}

all_insurance <- merge(prop_insurance, overall_insurance)
head(all_insurance)
```

```{r columnremoval}

all_insurance <- all_insurance[ -c(3,4,6)]
head(all_insurance)


```

## Finding the cost of each month

```{r}
head(events_data)
```

All the events have a begin date and an end date. For simplicity, we will be assuming the cost of one of the disasters is split evenly over the months in which it occured. To do so, since we don't care about the specific days, just the months and years, first we will floor all the dates to make them easier to work with

```{r}

events_data$Begin_Date <- floor_date(events_data$Begin_Date, "month")
events_data$End_Date <- floor_date(events_data$End_Date, "month")
head(events_data)
```

Next, we will get the number of months between the begin and end dates. Add one (to account for the starting month), and that will be the duration of our event (in months). We can then find the cost per month

(I got the at period code off stackexchange)

```{r}
events_data$Duration_Interval <- interval(events_data$Begin_Date, events_data$End_Date)

events_data$Duration_Months <- as.period(events_data$Duration_Interval
) %>% month() + 1
#events_data$Duration_Months

events_data$Adjusted_CPM_Millions <- events_data$CPI_Adjusted_Cost_Millions / events_data$Duration_Months

events_data$Unadjusted_CPM_Millions <- events_data$Unadjusted_Cost_Millions / events_data$Duration_Months

head(events_data)
```

We can use this data to view the relative cost of disasters - perhaps the longer lasting ones are less destructive per month or equally as so. We will do so in the preliminary visualization. However, now we have to get the cost of each disaster into the insurance data. First, we will remove the M from the month code so we have a year and month, then we can turn that into a date

```{r}
all_insurance$Month <- substr(all_insurance$Month_Code, 2, 3)
all_insurance$Calc_Date <- as.Date(
  paste(all_insurance$Year, all_insurance$Month, "1", sep = "-")
)
head(all_insurance)

```

Now, we can compare the calculated date to the interval in the events_data in order to see if that month incurred the cost of the event. This is very inefficient but its probably fine ahaha...

```{r}
stuff <- c(1:nrow(all_insurance))
stuff <- stuff * 0
#there's almost certainly a better way to come up with a list of size n with all 0s but i couldnt figure it out and its not that big of a deal probably
 

```

```{r savedata}
save.image("13_processedData.RData")
```
